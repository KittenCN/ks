
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>练习 30：有限状态机 · CoderFAN 资料库</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 6.0.3">
        <meta name="author" content="Todd Lyu">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="ex31.html" />
    
    
    <link rel="prev" href="part5.html" />
    
    <!-- MathJax 配置：唯一且完整 -->
<script>
    window.MathJax = {
      tex: {
        inlineMath:  [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true,
        processEnvironments: true,
        strict: "ignore",
        macros: { "\\E":"\\mathbb{E}", "\\Var":"\\operatorname{Var}" }
      },
    };
    </script>
    
    <!-- 核心脚本（defer不阻塞渲染） -->
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <!-- 放在 tex-chtml.js 之后 -->
    <script>
    (function () {
      function typeset() {
        if (window.MathJax && MathJax.typesetPromise) {
          MathJax.typesetPromise().catch(console.error);
        }
      }
    
      /* 第一次正文插入 */
      document.addEventListener('DOMContentLoaded', typeset);
    
      /*   关键：等待 gitbook.js 初始化成功   */
      function hookGitBook() {
        if (window.gitbook && gitbook.events) {
          gitbook.events.bind('page.change', typeset);   // 切章排版
        } else {
          /* gitbook.js 还没加载完 → 100 ms 后再试 */
          setTimeout(hookGitBook, 100);
        }
      }
      hookGitBook();   // 启动递归等待
    })();
    </script>
    
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
            
                <nav role="navigation">
                <a href=".." class="btn"><b></b>&#128512;返回上层&#128512;</b></a>
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    笨办法学 Python · 续 中文版
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="READ_ME.html">
            
                <a href="READ_ME.html">
            
                    
                    笨办法学 Python · 续 中文版
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="intro.html">
            
                <a href="intro.html">
            
                    
                    引言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="part1.html">
            
                <a href="part1.html">
            
                    
                    第一部分：预备知识
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="ex0.html">
            
                <a href="ex0.html">
            
                    
                    练习 0：起步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5" data-path="ex1.html">
            
                <a href="ex1.html">
            
                    
                    练习 1：流程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6" data-path="ex2.html">
            
                <a href="ex2.html">
            
                    
                    练习 2：创造力
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.7" data-path="ex3.html">
            
                <a href="ex3.html">
            
                    
                    练习 3：质量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.8" data-path="part2.html">
            
                <a href="part2.html">
            
                    
                    第二部分：简单的黑魔法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.9" data-path="ex4.html">
            
                <a href="ex4.html">
            
                    
                    练习 4：处理命令行参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.10" data-path="ex5.html">
            
                <a href="ex5.html">
            
                    
                    练习 5：cat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.11" data-path="ex6.html">
            
                <a href="ex6.html">
            
                    
                    练习 6：find
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.12" data-path="ex7.html">
            
                <a href="ex7.html">
            
                    
                    练习 7：grep
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.13" data-path="ex8.html">
            
                <a href="ex8.html">
            
                    
                    练习 8：cut
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.14" data-path="ex9.html">
            
                <a href="ex9.html">
            
                    
                    练习 9：sed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.15" data-path="ex10.html">
            
                <a href="ex10.html">
            
                    
                    练习 10：sort
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.16" data-path="ex11.html">
            
                <a href="ex11.html">
            
                    
                    练习 11：uniq
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.17" data-path="ex12.html">
            
                <a href="ex12.html">
            
                    
                    练习 12：复习
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.18" data-path="part3.html">
            
                <a href="part3.html">
            
                    
                    第三部分：数据结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.19" data-path="ex13.html">
            
                <a href="ex13.html">
            
                    
                    练习 13：单链表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.20" data-path="ex14.html">
            
                <a href="ex14.html">
            
                    
                    练习 14：双链表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.21" data-path="ex15.html">
            
                <a href="ex15.html">
            
                    
                    练习 15：栈和队列
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.22" data-path="ex16.html">
            
                <a href="ex16.html">
            
                    
                    练习 16：冒泡、快速和归并排序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.23" data-path="ex17.html">
            
                <a href="ex17.html">
            
                    
                    练习 17：字典
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.24" data-path="ex18.html">
            
                <a href="ex18.html">
            
                    
                    练习 18：性能测量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.25" data-path="ex19.html">
            
                <a href="ex19.html">
            
                    
                    练习 19：改善性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.26" data-path="ex20.html">
            
                <a href="ex20.html">
            
                    
                    练习 20：二叉搜索树
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.27" data-path="ex21.html">
            
                <a href="ex21.html">
            
                    
                    练习 21：二分搜索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.28" data-path="ex22.html">
            
                <a href="ex22.html">
            
                    
                    练习 22：后缀数组
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.29" data-path="ex23.html">
            
                <a href="ex23.html">
            
                    
                    练习 23：三叉搜索树
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.30" data-path="ex24.html">
            
                <a href="ex24.html">
            
                    
                    练习 24：URL 快速路由
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.31" data-path="part4.html">
            
                <a href="part4.html">
            
                    
                    第四部分：进阶项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.32" data-path="ex25.html">
            
                <a href="ex25.html">
            
                    
                    练习 25：xargs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.33" data-path="ex26.html">
            
                <a href="ex26.html">
            
                    
                    练习 26：hexdump
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.34" data-path="ex27.html">
            
                <a href="ex27.html">
            
                    
                    练习 27：tr
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.35" data-path="ex28.html">
            
                <a href="ex28.html">
            
                    
                    练习 28：sh
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.36" data-path="ex29.html">
            
                <a href="ex29.html">
            
                    
                    练习 29：diff和patch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.37" data-path="part5.html">
            
                <a href="part5.html">
            
                    
                    第五部分：文本解析
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.1.38" data-path="ex30.html">
            
                <a href="ex30.html">
            
                    
                    练习 30：有限状态机
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.39" data-path="ex31.html">
            
                <a href="ex31.html">
            
                    
                    练习 31：正则表达式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.40" data-path="ex32.html">
            
                <a href="ex32.html">
            
                    
                    练习 32：扫描器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.41" data-path="ex33.html">
            
                <a href="ex33.html">
            
                    
                    练习 33：解析器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.42" data-path="ex34.html">
            
                <a href="ex34.html">
            
                    
                    练习 34：分析器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.43" data-path="ex35.html">
            
                <a href="ex35.html">
            
                    
                    练习 35：解释器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.44" data-path="ex36.html">
            
                <a href="ex36.html">
            
                    
                    练习 36：简单的计算器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.45" data-path="ex37.html">
            
                <a href="ex37.html">
            
                    
                    练习 37：小型 BASIC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.46" data-path="part6.html">
            
                <a href="part6.html">
            
                    
                    第六部分：SQL 和对象关系映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.47" data-path="ex38.html">
            
                <a href="ex38.html">
            
                    
                    练习 38：SQL 简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.48" data-path="ex39.html">
            
                <a href="ex39.html">
            
                    
                    练习 39：SQL 创建
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.49" data-path="ex40.html">
            
                <a href="ex40.html">
            
                    
                    练习 40：SQL 读取
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.50" data-path="ex41.html">
            
                <a href="ex41.html">
            
                    
                    练习 41：SQL 更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.51" data-path="ex42.html">
            
                <a href="ex42.html">
            
                    
                    练习 42：SQL 删除
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.52" data-path="ex43.html">
            
                <a href="ex43.html">
            
                    
                    练习 43：SQL 管理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.53" data-path="ex44.html">
            
                <a href="ex44.html">
            
                    
                    练习 44：使用 Python 的数据库 API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.54" data-path="ex45.html">
            
                <a href="ex45.html">
            
                    
                    练习 45：创建 ORM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.55" data-path="part7.html">
            
                <a href="part7.html">
            
                    
                    第七部分：大作业
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.56" data-path="ex46.html">
            
                <a href="ex46.html">
            
                    
                    练习 46：blog
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.57" data-path="ex47.html">
            
                <a href="ex47.html">
            
                    
                    练习 47：bc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.58" data-path="ex48.html">
            
                <a href="ex48.html">
            
                    
                    练习 48：ed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.59" data-path="ex49.html">
            
                <a href="ex49.html">
            
                    
                    练习 49：sed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.60" data-path="ex50.html">
            
                <a href="ex50.html">
            
                    
                    练习 50：vi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.61" data-path="ex51.html">
            
                <a href="ex51.html">
            
                    
                    练习 51：lessweb
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.62" data-path="ex52.html">
            
                <a href="ex52.html">
            
                    
                    练习 52：moreweb
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >练习 30：有限状态机</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
                                <section class="normal markdown-section">
                                
                                <h1 id="练习-30：有限状态机">练习 30：有限状态机</h1>
<blockquote>
<p>原文：<a href="https://learncodethehardway.org/more-python-book/ex30.html" target="_blank">Exercise 30: Finite State Machines</a></p>
<p>译者：<a href="https://github.com/wizardforcel" target="_blank">飞龙</a></p>
<p>协议：<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></p>
<p>自豪地采用<a href="https://translate.google.cn/" target="_blank">谷歌翻译</a></p>
</blockquote>
<p>每当你阅读一本关于解析的书，都有一个可怕的章节，关于有限状态机（FSM）。他们对“边”和“节点”进行了详细的分析，每个可能的“自动机”的组合被转换成其他自动机，坦率地说，它有点多了。FSM 有一个更简单的解释，使得它们实用并且可理解，而不会违背相同主题的纯理论版本。当然你不会向 ACM 提交论文，因为你不知道 FSM 背后的所有数学知识，但如果你只想在应用程序中使用它们，那么它们就足够简单了。</p>
<p>FSM 是组织事件一种方式，事件发生在一系列状态上。定义事件的另一种方法是“输入触发器”，类似于<code>if</code>语句中的布尔表达式，但通常不太复杂。事件可以是按钮点击，从流中接收字符，更改日期或时间，以及几乎任何用于声明事件的东西。状态就是你的 FSM 停止的任何“位置”，同时它等待更多的事件，并且你定义的每个状态都允许事件（输入）。事件往往是暂时的，而状态通常是固定的，而且二者都是可以存储的数据。最后，你可以将代码附加到事件或状态，甚至决定在进入状态时，状态中或退出状态时是否应运行代码。</p>
<p>FSM 只是一种方法，在执行中不同位置发生不同事件时，使用白名单列出可能运行的代码。在 FSM 中，当你收到意外事件时，你会发生故障，因为你必须明确说明每个状态允许哪些事件（或条件）。<code>if</code>语句也可以处理可能的分支，但它是一个可能性的黑名单。如果你忘记了<code>else</code>子句，那么你的<code>if-elif</code>条件没有覆盖的任何东西都会退回默认。</p>
<p>让我们将其拆解：</p>
<ul>
<li>你拥有状态，这是 FSM 当前所在位置的存储指示器。状态可以是“开始”，“按下某键”，“中止”或类似的方式，描述执行的可能位置中的 FSM 的位置。每个状态都意味着正在等待某事发生，在决定下一步做什么之前。</li>
<li>你拥有事件，可以将 FSM 从一个状态移动到另一个状态。事件可以是“按下某键”，“套接字连接失败”，“文件保存”，并表示 FSM 接收到一些外部刺激，因此必须决定要做什么，以及下一个状态是什么。一个事件甚至可以回到同一个状态，这是你循环的方式。</li>
<li>根据发生的事件，FSM 从一个状态转换到另一个状态，并且仅仅由于为状态提供的确切事件（尽管其中一个事件可以定义为“任何事件”）。他们不会“意外”转移状态，你可以通过查看收到的事件和访问的状态，精确地跟踪他们从一个状态转移到另一个状态。这使得它们非常容易调试。</li>
<li>在状态转换之前，之后和期间，你可以在每个事件上运行代码。这意味着你可以在收到事件时运行一些代码，然后决定在该状态下基于该事件做什么，然后在离开该状态之前再次运行代码。这种执行代码的功能使得 FSM 非常强大。</li>
<li>有时候“没有”也是一个事件。这很好很强大，因为这意味着即使没有发生任何事情，你也可以将 FSM 转换到新的状态。然而，实际上，“没有”往往是隐含的事件“再来一次”或“醒来”。在其他情况下，这个状态的意思是，“不确定，也许下一个事件会告诉我是什么状态。”</li>
</ul>
<p>FSM 的力量是能够明确地说明每个事件，事件只是正在接收的数据。这使得它们非常容易进行调试，测试和正确实现，因为你确切地知道每个状态的可能性，以及在每个状态中，对于每个事件可能发生的情况。在本练习中，你将要研究 FSM 库和使用它的 FSM 实现，来了解它们如何工作。</p>
<h2 id="挑战练习">挑战练习</h2>
<p>我创建了一个 FSM 模块，处理一些简单的事件来处理 Web 服务器的连接。这是一个虚构的 FSM，为你提供一个在 Python 中快速编写 FSM 的例子。它只是处理连接的基本框架，连接从套接字读取和写入，并且它缺少一些重要的东西，但这只是供你使用的一个很小的例子。</p>
<pre><code class="lang-py"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">START</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">return</span> LISTENING

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">LISTENING</span><span class="hljs-params">(event)</span>:</span>
    <span class="hljs-keyword">if</span> event == <span class="hljs-string">"connect"</span>:
        <span class="hljs-keyword">return</span> CONNECTED
    <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"error"</span>:
        <span class="hljs-keyword">return</span> LISTENING
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> ERROR

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">CONNECTED</span><span class="hljs-params">(event)</span>:</span>
    <span class="hljs-keyword">if</span> event == <span class="hljs-string">"accept"</span>:
        <span class="hljs-keyword">return</span> ACCEPTED
    <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"close"</span>:
        <span class="hljs-keyword">return</span> CLOSED
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> ERROR

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ACCEPTED</span><span class="hljs-params">(event)</span>:</span>
    <span class="hljs-keyword">if</span> event == <span class="hljs-string">"close"</span>:
        <span class="hljs-keyword">return</span> CLOSED
    <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"read"</span>:
        <span class="hljs-keyword">return</span> READING(event)
    <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"write"</span>:
        <span class="hljs-keyword">return</span> WRITING(event)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> ERROR

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">READING</span><span class="hljs-params">(event)</span>:</span>
    <span class="hljs-keyword">if</span> event == <span class="hljs-string">"read"</span>:
        <span class="hljs-keyword">return</span> READING
    <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"write"</span>:
        <span class="hljs-keyword">return</span> WRITING(event)
    <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"close"</span>:
        <span class="hljs-keyword">return</span> CLOSED
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> ERROR

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">WRITING</span><span class="hljs-params">(event)</span>:</span>
    <span class="hljs-keyword">if</span> event == <span class="hljs-string">"read"</span>:
        <span class="hljs-keyword">return</span> READING(event)
    <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"write"</span>:
        <span class="hljs-keyword">return</span> WRITING
    <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"close"</span>:
        <span class="hljs-keyword">return</span> CLOSED
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> ERROR

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">CLOSED</span><span class="hljs-params">(event)</span>:</span>
    <span class="hljs-keyword">return</span> LISTENING(event)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ERROR</span><span class="hljs-params">(event)</span>:</span>
    <span class="hljs-keyword">return</span> ERROR
</code></pre>
<p>也有一个小测试，向你展示如何运行这个 FSM：</p>
<pre><code class="lang-py"><span class="hljs-keyword">import</span> fsm

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_basic_connection</span><span class="hljs-params">()</span>:</span>
    state = fsm.START()
    script = [<span class="hljs-string">"connect"</span>, <span class="hljs-string">"accept"</span>, <span class="hljs-string">"read"</span>, <span class="hljs-string">"read"</span>, <span class="hljs-string">"write"</span>, <span class="hljs-string">"close"</span>, <span class="hljs-string">"connect"</span>]

    <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> script:
        print(event, <span class="hljs-string">"&gt;&gt;&gt;"</span>, state)
        state = state(event)
</code></pre>
<p>你在本练习中的挑战是，将此示例模块变成一个更强大和通用的 FSM Python 类。你应该使用它作为一系列线索，来了解如何处理进入的事件，状态如何作为 Python 函数，以及如何进行隐式的转换。看看我有时候为下一个状态返回函数，但其​​他时候我会返回一个状态函数的调用？试着弄清楚为什么我会这样做，因为它在 FSM 中非常重要。</p>
<p>为了完成这个挑战，你需要学习 Python <a href="https://docs.python.org/3/library/inspect.html" target="_blank"><code>inspect</code></a>模块，看看你可以用 Python 对象和类来做什么。有一些特殊的变量，如<code>__dict__</code>以及<code>inspect</code>中的函数，可帮助你窥探类或对象并查找函数。</p>
<p>你也可以决定要反转此设计。你可以将事件作为子类中的函数，并在事件函数内检查当前的<code>self.state</code>，来确定接下来要执行的操作。这完全都取决于你正在处理什么，你是否拥有更多的事件还是状态，当时什么有意义。</p>
<p>最后，你可以使用一个设计，其中有一个<code>FSMRunner</code>类，它只知道如何运行这样设计的模块。这比一个知道如何运行自身实例的单一类有一些优点，但也有一些问题。例如，<code>FSMRunner</code>如何跟踪当前状态？它放在模块中还是在<code>FSMRunner</code>的实例中？</p>
<h2 id="研究性学习">研究性学习</h2>
<ul>
<li>使你的测试更加泛用，并为你熟悉的完全不同的领域做一个FSM。</li>
<li>添加一个功能，启动在你的实现中运行的事件的日志。使用 FSM 处理事件的最大优点之一是，可以存储和记录 FSM 收到的所有事件和状态。这可以让你调试，为什么它达到你不需要的状态。</li>
</ul>
<h2 id="深入学习">深入学习</h2>
<p>你应该仔细研究 FSM 背后的数学。我这里的小例子不是完全形式化的概念版本，以便你能理解它。</p>

                                
                                </section>
                            
                        </div>
                    </div>
                
            </div>

            
                
                <a href="part5.html" class="navigation navigation-prev " aria-label="Previous page: 第五部分：文本解析">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="ex31.html" class="navigation navigation-next " aria-label="Next page: 练习 31：正则表达式">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"练习 30：有限状态机","level":"1.1.38","depth":2,"next":{"title":"练习 31：正则表达式","level":"1.1.39","depth":2,"path":"ex31.md","ref":"ex31.md","articles":[]},"previous":{"title":"第五部分：文本解析","level":"1.1.37","depth":2,"path":"part5.md","ref":"part5.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-search","-livereload","-lunr","-fontsettings","highlight","expandable-chapters-small","back-to-top-button","github","code","theme-default"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{"lang":{"eval_rst":"rst","toc":"text"}},"github":{"url":"https://github.com/KittenCN"},"expandable-chapters-small":{},"back-to-top-button":{},"code":{"copyButtons":true},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Todd Lyu","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"CoderFAN 资料库","gitbook":"*"},"file":{"path":"ex30.md","mtime":"2017-12-26T13:55:22.000Z","type":"markdown"},"gitbook":{"version":"6.0.3","time":"2025-05-05T04:19:23.504Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-code/plugin.js"></script>
        
    

    </body>
</html>

