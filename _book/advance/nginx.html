
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Nginx · CoderFAN 资料库</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 6.0.3">
        <meta name="author" content="Todd Lyu">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="linux.html" />
    
    
    <link rel="prev" href="ab.html" />
    
    <!-- MathJax 配置：唯一且完整 -->
<script>
    window.MathJax = {
      tex: {
        inlineMath:  [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true,
        processEnvironments: true,
        strict: "ignore",
        macros: { "\\E":"\\mathbb{E}", "\\Var":"\\operatorname{Var}" }
      },
    };
    </script>
    
    <!-- 核心脚本（defer不阻塞渲染） -->
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <!-- 放在 tex-chtml.js 之后 -->
    <script>
    (function () {
      function typeset() {
        if (window.MathJax && MathJax.typesetPromise) {
          MathJax.typesetPromise().catch(console.error);
        }
      }
    
      /* 第一次正文插入 */
      document.addEventListener('DOMContentLoaded', typeset);
    
      /*   关键：等待 gitbook.js 初始化成功   */
      function hookGitBook() {
        if (window.gitbook && gitbook.events) {
          gitbook.events.bind('page.change', typeset);   // 切章排版
        } else {
          /* gitbook.js 还没加载完 → 100 ms 后再试 */
          setTimeout(hookGitBook, 100);
        }
      }
      hookGitBook();   // 启动递归等待
    })();
    </script>
    
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
            
                <nav role="navigation">
                <a href=".." class="btn"><b></b>&#128512;返回上层&#128512;</b></a>
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    进阶知识
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="structure.html">
            
                <a href="structure.html">
            
                    
                    数据结构与算法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="test.html">
            
                <a href="test.html">
            
                    
                    测试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="jest.html">
            
                <a href="jest.html">
            
                    
                    Jest
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="xss.html">
            
                <a href="xss.html">
            
                    
                    XSS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5" data-path="electron.html">
            
                <a href="electron.html">
            
                    
                    Electron
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6" data-path="performance.html">
            
                <a href="performance.html">
            
                    
                    性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.7" data-path="watch.html">
            
                <a href="watch.html">
            
                    
                    监控
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.8" data-path="node.html">
            
                <a href="node.html">
            
                    
                    Node
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.9" data-path="ab.html">
            
                <a href="ab.html">
            
                    
                    Ab 压测
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.1.10" data-path="nginx.html">
            
                <a href="nginx.html">
            
                    
                    Nginx
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.11" data-path="linux.html">
            
                <a href="linux.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.12" data-path="ssh.html">
            
                <a href="ssh.html">
            
                    
                    SSH
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.13" data-path="docker.html">
            
                <a href="docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.14" data-path="crontab.html">
            
                <a href="crontab.html">
            
                    
                    crontab 定时任务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.15" data-path="vim.html">
            
                <a href="vim.html">
            
                    
                    Vim
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Nginx</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
                                <section class="normal markdown-section">
                                
                                <h1 id="nginx">Nginx</h1>
<div align="center">

  <img src="advance/img/nginx.png" width="300" alt="logo" align="center"></img>
</div>

<p>Nginx（发音同 engine x）是异步框架的网页服务器，也可以用作反向代理、负载平衡器和 HTTP 缓存。该软件由伊戈尔·赛索耶夫创建并于 2004 年首次公开发布。2011 年成立同名公司以提供支持</p>
<h2 id="优势">优势</h2>
<ol>
<li>解决 c10k 问题（万级并发问题）</li>
<li>IO 多路复用 多个描述符的 IO 操作都能在一个线程里并发交替顺序完成，复用线程 select 线性遍历文件描述符列表 1. 效率低下 2.最多只能有 1024 epoll 每当 fd 就绪，采用系统回调函数将 fd 放入 1.效率高 2.没有 1024 限制</li>
<li>CPU 亲和 一种把 CPU 核心和 Nginx 工作进程绑定方式，把每个 worker 进程固定在一个 CPU 上执行，减少切换 CPU 和提交缓存命中率,获得更好的性能。</li>
<li>sendfile 零拷贝传输模式 ![usercore]</li>
</ol>
<h2 id="nginx-配置">Nginx 配置</h2>
<pre><code class="lang-bash"><span class="hljs-comment"># 设置工作进程的数量</span>
worker_processes  <span class="hljs-number">1</span>;
<span class="hljs-comment"># 处理连接</span>
events {
    <span class="hljs-comment"># 设置连接数</span>
    worker_connections  <span class="hljs-number">1024</span>;
}

http {
    <span class="hljs-comment"># 文件拓展名查找集合</span>
    include       mime.types;
    <span class="hljs-comment"># 当查找不到对应类型的时候默认值</span>
    default_<span class="hljs-built_in">type</span>  application/octet-stream;

    <span class="hljs-comment"># 日志格式，定义别名为 main</span>
    <span class="hljs-comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span>
    <span class="hljs-comment">#                  '$status $body_bytes_sent "$http_referer" '</span>
    <span class="hljs-comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span>

    <span class="hljs-comment"># 指定日志输入目录</span>
    <span class="hljs-comment">#access_log  logs/access.log  main;</span>

    <span class="hljs-comment"># 调用 sendfile 系统传输文件</span>
    sendfile        on;
    <span class="hljs-comment">#tcp_nopush     on;</span>

    <span class="hljs-comment"># 客户端与服务器连接超时时间，超时自动断开</span>
    <span class="hljs-comment">#keepalive_timeout  0;</span>
    keepalive_timeout  <span class="hljs-number">65</span>;

    <span class="hljs-comment"># 开启gizip 压缩</span>
    <span class="hljs-comment">#gzip  on;</span>

    <span class="hljs-comment"># 虚拟主机</span>
    server {
        listen       <span class="hljs-number">80</span>;
        server_name  localhost;

        <span class="hljs-comment">#charset koi8-r;</span>

        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span>

        <span class="hljs-comment"># 路由</span>
        location / {
                root   html;
                index  index.html index.htm;
            }
    }

    <span class="hljs-comment"># 引入其他的配置文件</span>
    include servers/*;
}
</code></pre>
<!-- ## unbuntu 下载 nginx

```code
    wget http://nginx.org/download/nginx-1.13.6.tar.gz
    tar -xvf  nginx //解压
-   进入 nginx
    sudo ./configure
    //报错的话执行
    sudo apt-get install libpcre3 libpcre3-dev
    sudo apt-get install openssl libssl-dev
    执行 install make
    进入安装后的文件夹
    进入 sbin
    启动 sudo ./nginx
```
 -->
<h2 id="常用的-nginx-命令">常用的 nginx 命令</h2>
<pre><code class="lang-bash">systemctl start nginx   启动nginx
ps –ef | grep nginx 查看 nginx 进程
netstat -ntpl <span class="hljs-number">80</span> 查看端口号
nginx -v  //查看版本
nginx -t //测试配置是否正确
nginx <span class="hljs-operator">-s</span> stop  //停止nginx
nginx <span class="hljs-operator">-s</span> qute  //优雅停止nginx
nginx <span class="hljs-operator">-s</span> reload //重启nginx
nginx <span class="hljs-operator">-s</span> reopen //重新打开日志
</code></pre>
<h2 id="日志备份">日志备份</h2>
<p>mv logs/assets.bak logs/assets.lock.bak
nginx -s reopen 重新打开日志</p>
<p>rewrite 重写
rewrite （*.)$ /index/$1
try_files $uri ? /index.html?$uri</p>
<h2 id="强缓存">强缓存</h2>
<p>!&gt;Cache-Control 的优先级高于 Expires</p>
<p>1· expires 30d;
1· Cache-Control
1· add_header Cache-Control no-cache;</p>
<h2 id="协商缓存">协商缓存</h2>
<ol>
<li>etag on</li>
<li>last-modified</li>
</ol>
<h2 id="压缩">压缩</h2>
<pre><code class="lang-bash">  gzip on;
  gzip_static on; //静态资源
  gzip_vary on;  //是否在 http header 中添加 Vary: Accept-Encoding，建议开启
  gzip_comp_level <span class="hljs-number">5</span>; //(建议) gzip 压缩比，<span class="hljs-number">1</span> 压缩比最小处理速度最快，<span class="hljs-number">9</span> 压缩比最大但处理最慢（传输快但比较消耗 cpu）
  gzip_min_length <span class="hljs-number">0</span> ; //默认值是 <span class="hljs-number">0</span>，不管页面多大都压缩。 建议设置成大于 <span class="hljs-number">1</span>k 的字节数，小于 <span class="hljs-number">1</span>k 可能会越压越大
  gzip_http_version <span class="hljs-number">1.1</span>; //版本信息
  gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;
</code></pre>
<h2 id="动静分离">动静分离</h2>
<p><img src="img/nginx/nginx02.jpg" alt=""></img></p>
<pre><code class="lang-bash">location ～ .\.(jpg|png|jpeg) $ {
proxy_pass http://<span class="hljs-number">192.168</span>.<span class="hljs-number">1.2</span>.<span class="hljs-number">0</span>:<span class="hljs-number">90</span>
proxy_<span class="hljs-built_in">set</span>_header X_Forwarded_<span class="hljs-keyword">for</span> <span class="hljs-variable">$remote_addr</span>; //设置头部 IP 地址
}
</code></pre>
<h2 id="配置文件访问权限防盗链">配置文件访问权限(防盗链)</h2>
<pre><code class="lang-bash">   location ～ .\.(jpg|png) $ {
        valid_referers none blocked <span class="hljs-number">192.186</span>.<span class="hljs-number">1.1</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$invalid_referer</span>) {
                <span class="hljs-built_in">return</span> <span class="hljs-number">403</span>;
        }
        root /data/images
        }
</code></pre>
<ul>
<li><p>valid_referers</p>
<ul>
<li>none : 允许没有 http_refer 的请求访问资源；</li>
<li>blocked : 允许不是<a href="http://开头的，不带协议的请求访问资源；" target="_blank">http://开头的，不带协议的请求访问资源；</a></li>
<li>119.28.190.215 : 只允许指定 ip 来的请求访问资源；</li>
</ul>
</li>
</ul>
<h2 id="配置跨域">配置跨域</h2>
<pre><code class="lang-bash">location ~ .*\.json$ {
        add_header Access-Control-Allow-Origin http://localhost:<span class="hljs-number">3000</span>;
        add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;
        root /data/json;
    }
</code></pre>
<!-- ## 随机展示文件

```bash
location /  {
            root  /usr/share/nginx/html;
            random_index  on;
    }
``` -->
<!-- ## 文件修改

```bash
location /  {
            root  /usr/share/nginx/html;
            index index.html index.htm;
            sub_filter 'work' 'hello';
            sub_filter_once :off;
    }
``` -->
<h2 id="配置反向代理">配置反向代理</h2>
<pre><code class="lang-bash"> upstream web_crm {
        server <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>;
}
   location /crm/ {
            proxy_pass http://web_crm/crm/;
            proxy_redirect  off;
            proxy_<span class="hljs-built_in">set</span>_header Host <span class="hljs-variable">$host</span>;
            proxy_http_version <span class="hljs-number">1.1</span>;
            proxy_<span class="hljs-built_in">set</span>_header Upgrade <span class="hljs-variable">$http_upgrade</span>;
            proxy_<span class="hljs-built_in">set</span>_header Connection ‘upgrade’;
            proxy_cache_bypass <span class="hljs-variable">$http_upgrade</span>;
            proxy_<span class="hljs-built_in">set</span>_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;
            proxy_<span class="hljs-built_in">set</span>_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
        }
</code></pre>
<h2 id="过滤网络爬虫">过滤网络爬虫</h2>
<pre><code class="lang-bash"> location / {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$http_user_agent</span> ~* <span class="hljs-string">"python|curl|java|wget|httpclient|okhttp"</span>) {
            <span class="hljs-built_in">return</span> <span class="hljs-number">503</span>;
        }
        <span class="hljs-comment"># 正常处理</span>
        ...
    }
</code></pre>
<h2 id="url-重定向">URL 重定向</h2>
<pre><code class="lang-bash">server {
        listen        <span class="hljs-number">80</span>;
        server_name www.abc.com;
        location / {
            rewrite ^/ http://<span class="hljs-number">192.168</span>.<span class="hljs-number">18.250</span>;

          }
}
</code></pre>
<h2 id="配置负载均衡">配置负载均衡</h2>
<p><img src="img/nginx/nginx01.jpg" alt=""></img></p>
<pre><code class="lang-bash">upstream web_mgrsys {
    server <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8090</span> weight=<span class="hljs-number">10</span>;
    server <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">3000</span> weight=<span class="hljs-number">3</span>;
}
proxy_pass http://web_mgrsys;
</code></pre>
<h3 id="负载均衡算法（策略）：">负载均衡算法（策略）：</h3>
<ol>
<li>基于 cookie 值区别用户</li>
<li>基于 uri 利用一致性算法</li>
<li>基于 IP 地址</li>
</ol>
<h3 id="其他参数">其他参数</h3>
<ul>
<li>1.backup ：备份机，所有服务器挂了之后才会生效</li>
<li>2.Weight：默认为 1.weight 越大，负载的权重就越大。</li>
<li>3.max_fails：允许请求失败的次数默认为 1.当超过最大次数时，返回 proxy_next_upstream 模块定义的错误</li>
<li>4.fail_timeout：max_fails 次失败后，暂停的时间。</li>
<li>5.max_conns：限制分配给某台 Server 处理的最大连接数量，超过这个数量，将不会分配新的连接给它。默认为 0，表示不限制。注意：1.5.9 之后的版本才有这个配置</li>
<li>6 ip_hash; 每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决 session 的问题</li>
<li>7 least_conn 最小连接数，哪个连接少就分给谁</li>
<li>8 url_hash（第三方) 按访问的 URL 地址来分配 请求，每个 URL 都定向到同一个后端 服务器上(缓存)</li>
<li>9 fair（第三方) 按后端服务器的响应时间来分配请求，响应时间短的优先分配。</li>
</ul>
<h2 id="https">https</h2>
<p>ssl on;
ssl_certificate_key ../certs</p>
<h3 id="if-指令的条件表达式">if 指令的条件表达式</h3>
<ul>
<li>检查变量为空或者值是否为 0,直接使用</li>
<li>将变量与字符串做匹配,使用=或者 !=</li>
<li>将变量与正则表达式做匹配<blockquote>
<ul>
<li>大小写敏感,~或者!</li>
<li>大小写不敏感,*或者!</li>
</ul>
</blockquote>
</li>
<li>检查文件是否存在,使用-f 或者 !-f</li>
<li>检查目录是否存在,使用 d 或者 !d</li>
<li>检查文件、目录、软链接是否存在,使用-e 或者!-e</li>
<li>检查是否为可执行文件,使用 x 或者!-x</li>
</ul>
<h3 id="location-匹配规则">location 匹配规则</h3>
<p>常规
= ：精确匹配
^～：匹配后不再进行正则匹配
然后使用最长的前缀字符串</p>
<h2 id="限制客户端的并发连接数">限制客户端的并发连接数</h2>
<p>ngx_http_limit_conn_module</p>
<h2 id="限制客户端的每秒处理请求数">限制客户端的每秒处理请求数</h2>
<p>ngx_http_limit_req_module</p>
<h2 id="请求限制">请求限制</h2>
<p>limit_req_zone</p>
<h2 id="cpu-核数">cpu 核数</h2>
<p>worker_cpu_affinity</p>
<h2 id="限制-ip-地址访问">限制 IP 地址访问</h2>
<pre><code class="lang-bash">location / {
deny <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span>;
}
</code></pre>
<h2 id="浏览器缓存与-nginx-缀存">浏览器缓存与 nginx 缀存</h2>
<h3 id="浏览器缓存">浏览器缓存</h3>
<p><img src="img/nginx/nginx03.png" alt=""></img></p>
<p>优点</p>
<ol>
<li>使用有效缓存时,没有网络消耗,速度最快</li>
<li>即使有网络消耗,但对失效缓存使用 304 响应做到网络流量消耗最小化</li>
</ol>
<p>缺点</p>
<p>仅提升一个用户的体验</p>
<h3 id="nginx-缓存">nginx 缓存</h3>
<p><img src="img/nginx/nginx04.jpg" alt=""></img></p>
<p>优点</p>
<ol>
<li>提升所有用户的体验</li>
<li>相比浏览器缓存,有效降低上游服务的負载</li>
<li>通过 304 响应减少 nginx 与上游服务间的流量消耗</li>
</ol>
<p>缺点</p>
<ol>
<li>用户仍然保持网络消耗
1 同时使用浏览器与 nginx 缓存</li>
</ol>
<h2 id="nginx-内置变量">nginx 内置变量</h2>
<pre><code class="lang-bash"><span class="hljs-variable">$arg_PARAMETER</span> 这个变量值为：GET请求中变量名PARAMETER参数的值。
<span class="hljs-variable">$args</span> 这个变量等于GET请求中的参数。例如，foo=<span class="hljs-number">123</span>&amp;bar=blahblah;这个变量只可以被修改
<span class="hljs-variable">$binary_remote_addr</span> 二进制码形式的客户端地址。
<span class="hljs-variable">$body_bytes_sent</span> 传送页面的字节数
<span class="hljs-variable">$content_length</span> 请求头中的Content-length字段。
<span class="hljs-variable">$content_type</span> 请求头中的Content-Type字段。
<span class="hljs-variable">$cookie_COOKIE</span> cookie COOKIE的值。
<span class="hljs-variable">$document_root</span> 当前请求在root指令中指定的值。
<span class="hljs-variable">$document_uri</span> 与<span class="hljs-variable">$uri</span>相同。
<span class="hljs-variable">$host</span> 请求中的主机头(Host)字段，如果请求中的主机头不可用或者空，则为处理请求的server名称(处理请求的server的server_name指令的值)。值为小写，不包含端口。
<span class="hljs-variable">$hostname</span>  机器名使用 gethostname系统调用的值
<span class="hljs-variable">$http_HEADER</span>   HTTP请求头中的内容，HEADER为HTTP请求中的内容转为小写，-变为_(破折号变为下划线)，例如：<span class="hljs-variable">$http_user_agent</span>(Uaer-Agent的值), <span class="hljs-variable">$http_referer</span>...;
<span class="hljs-variable">$sent_http_HEADER</span>  HTTP响应头中的内容，HEADER为HTTP响应中的内容转为小写，-变为_(破折号变为下划线)，例如： <span class="hljs-variable">$sent_http_cache_control</span>, <span class="hljs-variable">$sent_http_content_type</span>...;
<span class="hljs-variable">$is_args</span> 如果<span class="hljs-variable">$args</span>设置，值为<span class="hljs-string">"?"</span>，否则为<span class="hljs-string">""</span>。
<span class="hljs-variable">$limit_rate</span> 这个变量可以限制连接速率。
<span class="hljs-variable">$nginx_version</span> 当前运行的nginx版本号。
<span class="hljs-variable">$query_string</span> 与<span class="hljs-variable">$args</span>相同。
<span class="hljs-variable">$remote_addr</span> 客户端的IP地址。
<span class="hljs-variable">$remote_port</span> 客户端的端口。
<span class="hljs-variable">$remote_user</span> 已经经过Auth Basic Module验证的用户名。
<span class="hljs-variable">$request_filename</span> 当前连接请求的文件路径，由root或<span class="hljs-built_in">alias</span>指令与URI请求生成。
<span class="hljs-variable">$request_body</span> 这个变量（<span class="hljs-number">0.7</span>.<span class="hljs-number">58</span>+）包含请求的主要信息。在使用proxy_pass或fastcgi_pass指令的location中比较有意义。
<span class="hljs-variable">$request_body_file</span> 客户端请求主体信息的临时文件名。
<span class="hljs-variable">$request_completion</span> 如果请求成功，设为<span class="hljs-string">"OK"</span>；如果请求未完成或者不是一系列请求中最后一部分则设为空。
<span class="hljs-variable">$request_method</span> 这个变量是客户端请求的动作，通常为GET或POST。
包括<span class="hljs-number">0.8</span>.<span class="hljs-number">20</span>及之前的版本中，这个变量总为main request中的动作，如果当前请求是一个子请求，并不使用这个当前请求的动作。
<span class="hljs-variable">$request_uri</span> 这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看<span class="hljs-variable">$uri</span>更改或重写URI。
<span class="hljs-variable">$scheme</span> 所用的协议，比如http或者是https，比如rewrite ^(.+)$ <span class="hljs-variable">$scheme</span>://example.com<span class="hljs-variable">$1</span> redirect;
<span class="hljs-variable">$server_addr</span> 服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在listen中指定地址并且使用<span class="hljs-built_in">bind</span>参数。
<span class="hljs-variable">$server_name</span> 服务器名称。
<span class="hljs-variable">$server_port</span> 请求到达服务器的端口号。
<span class="hljs-variable">$server_protocol</span> 请求使用的协议，通常是HTTP/<span class="hljs-number">1.0</span>或HTTP/<span class="hljs-number">1.1</span>。
<span class="hljs-variable">$uri</span> 请求中的当前URI(不带请求参数，参数位于<span class="hljs-variable">$args</span>)，不同于浏览器传递的<span class="hljs-variable">$request_uri</span>的值，它可以通过内部重定向，或者使用index指令进行修改。不包括协议和主机名，例如/foo/bar.html
</code></pre>
<h3 id="http-请求相关变量">http 请求相关变量</h3>
<ol>
<li>arg 参数名 ：URL 中某个具体参数的值</li>
<li>query_string: 与 args 变量完全相同</li>
<li>args : 全部 URL 参数</li>
<li>is_args: 如果请求 URL 中有参数则返回?否则返回空</li>
<li>content_length: http 请求中标识包体长度的 Content-Length 头部的值</li>
<li>content tvpe: 示识请求包体类型的 Content-Type 头部的值</li>
<li>uri:请求的 URI (不同于 URL,不包括?后的参数)</li>
<li>document_uri: 与 uri 完全相同</li>
<li>request_uri: 请求的 URL(包括 UR 以及完整的参数)</li>
<li>scheme: 协议名,例如 HTTP 或者 Https</li>
<li>request_method: 请求方法,例如 GET 或者 POST</li>
<li>request_length: 所有请求内容的大小,包括请求行、头部、包体等</li>
<li>remote_user: 由 Http Basic Authentication 协议传入的用户名</li>
<li>request_body_file : 临时存放请求包体的文件 client_body_in_file_only 强制所有包体存入的文件，且可是否决定删除</li>
<li>request_body : 临时存放请求包体的文件</li>
</ol>
<p>注 ⚠️</p>
<ol>
<li>先从请求行中获取</li>
<li>如果含有 Host 头部,则用其值替换掉请求行中的主机名</li>
<li>如果前两者都取不到,则使用匹配上的 server name</li>
</ol>
<h3 id="tcp-连接相关的变量">TCP 连接相关的变量</h3>
<ol>
<li>binary_remote_addr: 客户端地址的整型格式,对于 IPv4 是 4 字节,对于 Iv6 是 16 字节</li>
<li>connection: 递增的连接序号</li>
<li>connection_requests: 当前连接上执行过的请求数,对 keepalive 连接有意义</li>
<li>remote_addr: 客户端端口</li>
<li>remote_port: 客户端端口</li>
<li><p>proxy_protocol_addr: 若使用了 proxy protocol 协议则返回协议中的地址,否则返回空</p>
</li>
<li><p>proxy_protocol_port: 若使用了 proxy protocol 协议则返回协议中的端口,否则返回空</p>
</li>
<li>server_addr: 服务器端地址</li>
<li>server_port: 服务器端端口</li>
<li>TCP_INFO: tcp 内核层参数,包括 $tcpinfo_rtt, $tcpinfo_rttvar, $tcpinfo_snd_cwnd, $tcpinfo_rev_space</li>
<li>server protocol: 服务器端协议,例如 HTTP/1.l</li>
</ol>
<h3 id="nginx-处理请求过程中产生的变量">nginx 处理请求过程中产生的变量</h3>
<ol>
<li>request_time: 请求处理到现在的耗时,单位为秒,精确到毫秒</li>
<li>server_name: 匹配上请求的 server_name 值</li>
<li>https: 如果开启了 TLS/SSL,则返回 on,否则返回空</li>
<li>request_completion: 若请求处理完则返回 OK,否则返回空</li>
<li>request_id: 以 16 进制输出的请求标识 id,该 id 共含有 16 个字节,是随机生成的</li>
<li>request_filename: 待访问文件的完整路径</li>
<li>document_root:由 UR 和 root/alias 规则生成的文件夹路径</li>
<li>realpath_root: 将 document roc 中的软链接等换成真实路径</li>
<li>limit_rate:返回客户端响应时的速度上限,单位为每秒字节数。可以通过 set 指令修改对请求产生效果</li>
</ol>
<h3 id="nginx-系统变量">nginx 系统变量</h3>
<ol>
<li>time_local: 以本地时间标准输出的当前时间,例如 14Nov2018:15:55:37+C</li>
<li>time_iso8601: 使用 ISO8601 标准输出的当前时间,例如 2018-114T15:5:37</li>
<li>nginx-version: Nginx 版本号</li>
<li>pid: 所属 worker 进程的进程 id</li>
<li>pipe: 使用了管道则返回 p,否则返回</li>
<li>hostname: 所在服务器的主机名,与 hostname 命令输出一致</li>
<li>hostname: 1970 年 1 月 1 日到现在的时间,单位为秒,小数点后精确到毫秒</li>
<li>限制 proxy_next_upstream 的时间与次数</li>
<li>用 error_page 拦截上游失败相应</li>
</ol>
<h2 id="文件缓存配置">文件缓存配置</h2>
<ol>
<li>open_file_cache 打开缓存的同时也指定了缓存最大数目，以及缓存的时间。我们可以设置一个相对高的最大时间，这样我们可以在它们不活动超过 20 秒后清除掉。</li>
<li>open_file_cache_valid 在 open_file_cache 中指定检测正确信息的间隔时间。</li>
<li>open_file_cache_min_uses 定义了 open_file_cache 中指令参数不活动时间期间里最小的文件数。</li>
<li>open_file_cache_errors 指定了当搜索一个文件时是否缓存错误信息，也包括再次给配置中添加文件。我们也包括了服务器模块，这些是在不同文件中定义的。如果你的服务器模块不在这些位置，你就得修改这一行来指定正确的位置。</li>
</ol>
<!-- ## 问题

nginx 访问时报 403 设置 user 有问题； -->

                                
                                </section>
                            
                        </div>
                    </div>
                
            </div>

            
                
                <a href="ab.html" class="navigation navigation-prev " aria-label="Previous page: Ab 压测">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="linux.html" class="navigation navigation-next " aria-label="Next page: Linux">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Nginx","level":"1.1.10","depth":2,"next":{"title":"Linux","level":"1.1.11","depth":2,"path":"linux.md","ref":"linux.md","articles":[]},"previous":{"title":"Ab 压测","level":"1.1.9","depth":2,"path":"ab.md","ref":"ab.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-search","-livereload","-lunr","-fontsettings","highlight","expandable-chapters-small","back-to-top-button","github","code","theme-default"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{"lang":{"eval_rst":"rst","toc":"text"}},"github":{"url":"https://github.com/KittenCN"},"expandable-chapters-small":{},"back-to-top-button":{},"code":{"copyButtons":true},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Todd Lyu","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"CoderFAN 资料库","gitbook":"*"},"file":{"path":"nginx.md","mtime":"2025-05-03T00:31:50.295Z","type":"markdown"},"gitbook":{"version":"6.0.3","time":"2025-05-05T04:17:08.730Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-code/plugin.js"></script>
        
    

    </body>
</html>

